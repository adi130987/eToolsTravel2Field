<!-- ETOOLS FILE UPLOADER COMPONENT

Missing/todo: deletion, uploading, downloading, waiting for missing <etools-ajax> feature

For existing files:
===================
<etools-file-upload
  label="Click to upload TEST file"
  download-path="https://www.some_path-to-the-file_in_question6.com"
  file-name="somefile.jpg"></etools-file-upload>


For upload:
===========
<etools-file-upload label="" upload-path="//some-path.to6?upload_stuff/"></etools-file-upload>

-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<dom-module id="etools-file-upload">

  <style include="iron-flex">
    :host {
      display: block;
      margin-left: 12px;
      margin-right: 12px;
    }
    .floating-label {
      color: var(--gray-light);
      font-size: 12px;
    }
    paper-button.upload-button {
      height: 36px;
      line-height: 36px;
      width: 130px;
      padding: 0;
      color: var(--primary);
    }
    paper-button.upload-button iron-icon {
      --iron-icon-fill-color: var(--primary);
      margin-right: 10px;
    }

    .file-container {
      margin-bottom: 24px;
    }

    div.file-name {
      border-bottom: 1px solid var(--gray-light);
    }
    div.file-name iron-icon {
      color: var(--gray-mid);
      margin-right: 10px;
    }
    div.file-name span.label {
      font-size: 16px;
      padding-right: 10px;
      color: var(--gray-dark);
      height: 36px;
      line-height: 36px;
    }

    .buttons {
      margin-left: 24px;
    }

    .buttons paper-button {
      text-transform: none;
      font-weight: 500;
      font-size: 14px;
      color: var(--primary);
      height: 36px;
    }
    .buttons paper-button.del {
      color: var(--delete);
    }
    .buttons paper-button.load {
      color: var(--primary);
    }
    .buttons paper-button.load iron-icon {
      --iron-icon-fill-color: var(--primary);
      margin-right: 10px;
    }
    #downloader {
      diplay: none;
    }
  </style>

  <template>

    <p>FILE UPLOAD, multiple: [[multiple]], noUpload: [[noUpload]]</p>

    <span hidden$="[[multiple]]" class="floating-label">File attachment</span>
    <span hidden$="[[!multiple]]" class="floating-label">File attachments</span>

    <template is="dom-repeat" items="[[files]]">
      <div class="file-container horizontal layout center">

        <div class="file-name flex horizontal center layout">
          <iron-icon icon="attachment"></iron-icon>
          <span class="label">[[item.file_name]]</span>
        </div>

        <div class="buttons flex horizontal layout">

          <paper-button
            class="load"
            on-click="_btnDownload"
            hidden$=""[[_isThereURL(item)]]>
            <iron-icon icon="cloud-download"></iron-icon>
            Download
          </paper-button>

          <paper-button class="del" on-click="_btnDel">
            Delete
          </paper-button>
        </div>
      </div>
    </template>

    <input
      hidden
      type="file"
      id="fileInput"
      on-change="_fileSelected"
      multiple="{{multiple}}"
      accept="{{accept}}">

    <a id="downloader"></a>

    <template is="dom-if" if="[[_showUploadButton(multiple, noUpload, files)]]">
      <paper-button class="upload-button" on-click="_openFileChooser">
        <iron-icon icon="file-upload"></iron-icon>
        Upload file
      </paper-button>
    </template>

  </template>

  <script>
    Polymer({

      is: 'etools-file-upload',

      properties: {

        // Hides uploading button
        noUpload: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        },

        multiple: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        },

        files: {
          type: Array,
          notify: true,
          value: []
        }

      },

      _openFileChooser: function() {

        var elem = this.$.fileInput;
        if (elem && document.createEvent) {
          var evt = document.createEvent('MouseEvents');
          evt.initEvent('click', true, false);
          elem.dispatchEvent(evt);
        }
      },

      _fileSelected: function(e) {

        if (this.multiple) {
          var files = e.target.files;
          for(var i=0; i < files.length; i++) {
            this.push('files', {
              id: '',
              file_name: files[i].name,
              path: '',
              raw: files[i]
            });
          }
        } else {
          var file = e.target.files[0];
          this.push('files', {
            id: '',
            file_name: file.name,
            path: '',
            raw: file
          });
        }
        // console.info(this.files);
      },

      _btnDel: function() {

        console.log('TODO: Delete file from server, reset state');
      },

      _btnDownload: function(e) {

        var a = this.$.downloader;
        a.href = e.model.item.path;
        a.download = e.model.item.file_name;
        a.click();
        window.URL.revokeObjectURL(e.model.item.path);
      },

      _isThereURL: function(item) {

        return item.path !== '';
      },

      _showUploadButton: function(multiple, noUpload, files) {

        // console.log('noUpload', noUpload);
        // console.log('multiple', multiple);
        // console.log('files.length', files.length);
        var notShow = noUpload || (!multiple && files.length > 0);
        // console.log('notShow', notShow);
        return !notShow;
      }
    });
  </script>
</dom-module>
