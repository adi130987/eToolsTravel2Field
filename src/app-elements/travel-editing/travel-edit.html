<link rel="import"
  href="../../../bower_components/polymer/polymer.html">
<link rel="import"
  href="../../../bower_components/paper-material/paper-material.html">
<link rel="import"
  href="../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import"
  href="../../../bower_components/paper-tabs/paper-tab.html">
<link rel="import"
  href="../../../bower_components/iron-pages/iron-pages.html">
<link rel="import"
  href="../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import"
  href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import"
  href="../../../bower_components/paper-button/paper-button.html">
<link rel="import"
  href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import"
  href="travel-details.html">
<link rel="import"
  href="travel-attachments.html">
<link rel="import"
  href="travel-report.html">
<link rel="import"
  href="../et2f-header.html">

<link rel="import"
  href="../../../styles/shared-styles.html">
<link rel="import"
  href="../../../styles/et2f-styles.html">

<dom-module id="travel-edit">
  <template>
    <style include="shared-styles et2f-styles iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
        width: 100%;
        background-color: var(--gray-lighter);
      }
    </style>



    <template is="dom-if"
      if="{{travelId}}">
      <etools-ajax url="[[travelUrl]]"
        on-success="_handleData"></etools-ajax>
    </template>

    <template is="dom-if"
      if="[[postData]]">
      <etools-ajax url="[[url]]"
        body="[[serverData]]"
        method="[[method]]"
        on-success="_handlePostSuccess"
        on-fail="_handlePostFail"></etools-ajax>
    </template>

    <et2f-header title="Edit travel plan">
      <paper-tabs scrollable
        selected="{{selected}}">
        <paper-tab>Travel details</paper-tab>
        <paper-tab>Attachments</paper-tab>
        <paper-tab>Report</paper-tab>
      </paper-tabs>
    </et2f-header>

    <iron-pages selected="{{selected}}">

      <travel-details
        structure="[[structure]]"
        permissions="[[permissions]]"
        data="{{data}}"
        on-form-action="_handleFormAction">
      </travel-details>

      <travel-attachments></travel-attachments>

      <travel-report
        structure="[[structure]]"
        permissions="[[permissions]]"
        data="{{data}}"
        on-form-action="_handleFormAction">
      </travel-report>
    </iron-pages>

  </template>

  <script>
    Polymer({
      is: 'travel-edit',
      properties: {
        data: {
          type: Object,
          notify: true
        },
        structure: {
          type: Object,
        },
        permissions: {
          type: Object
        },
        selected: {
          type: Number,
          value: 0
        },
        newTravel: {
          type: Boolean,
          value: false
        },
        travelId: {
          type: String
        },
        travelUrl: {
          type: String,
          computed: '_computeUrl(travelId)'
        },
        postData: {
          type: Boolean,
          value: false
        },
        serverData: {
          type: Object,
          value: function () {
            return {}
          }
        }
      },
      _computeUrl: function(travelId) {
        this.set('data', {});
        this._resetData();
        return 'http://localhost:8000/api/et2f/travels'+ travelId + '/';
      },
      _handleData: function (e, data) {
        var self = this;

        var structureLib = {
          traveller: 'users',
          supervisor: 'users',
          office: 'offices',
          section: 'sections',
          start_date: function(item) {
            return new Date(item);
          },
          end_date: function(item) {
            return new Date(item);
          }
        };

        var statusLib = {
          "planned": "Planned",
          "submitted": "Submitted",
          "approved": "Approved",
          "rejected": "Rejected",
          "sent_for_payment": "Sent for payment",
          "cancelled": "Cancelled",
          "done": "Certification needed",
          "certification_approved": "Certification approved",
          "certification_rejected": "Certification rejected",
          "certification_submitted": "Certification submitted",
          "certified": "Completed",
        };


        var nonBaseKeys = [ 'deductions', 'itinerary', 'activities', 'cost_assignments', 'expenses', 'clearances'];
        var dataKeys = Object.keys(data).filter(function(key){
          return nonBaseKeys.indexOf(key) === -1;
        });
        data.baseDetails = {};
        dataKeys.forEach(function(key) {
          data.baseDetails[key] = data[key];
          delete data[key];
        });

        function handleArray(fieldSet) {
          if(fieldSet.length === 0) {
            // add one empty object in case of empty array
            fieldSet.push({});
          } else {
            //loop on array elements and run the object handling function
            fieldSet.forEach(function(innerFieldset) {
              handleObject(innerFieldset)
            })
          }
        }

        function handleObject(fieldSet) {
          // loop on the object inner keys
          if(!fieldSet) {
            return
          }
          var localKeys = Object.keys(fieldSet);
          localKeys.forEach(function(label) {
            // search the structure library for a match
            var structureData = structureLib[label];
            if(structureData) {
              //apply the matching function or the transformation from the structure
              if(typeof structureData  === 'function') {
                fieldSet[label] = structureData(fieldSet[label]);
              }
              else {
                fieldSet[label] = self.structure[structureData].find(function (item) {
                  return item.value === fieldSet[label];
                })
              }
            }
          })
        }

        var newKeys = Object.keys(data);
        newKeys.forEach(function (fieldSet) {
          if (data[fieldSet] instanceof Array) {
            handleArray(data[fieldSet]);
          }
          else if(typeof data[fieldSet] === 'object'){
            handleObject(data[fieldSet]);
          }
        });

        if(data.baseDetails.status) {
          data.status = statusLib[data.baseDetails.status];
        } else {
          data.status = statusLib['planned'];
        }
        this.set('data', data);
      },
      _processOutboundData: function (data) {
        var self = this;
        this.serverData = {
          deductions: [],
          itinerary: [],
          activities: [],
          cost_assignments: [],
          expenses: []
        };
        var baseDetailsKeys = Object.keys(data.baseDetails);
        baseDetailsKeys.forEach(function(key) {
          if(data.baseDetails[key]) {
            self.serverData[key] = typeof data.baseDetails[key] === 'object' ? data.baseDetails[key].value : data.baseDetails[key]
          }
        });
        delete self.serverData.status;
      },
      _handleFormAction: function (e, details) {
        this._processOutboundData(this.data);
        this.method = "POST";
        if (details.endPoint === 'save') {
          this.url = 'http://localhost:8000/api/et2f/travels/';
          if(this.travelId) {
            this.method = "PUT";
            this.url += this.travelId.replace('/', '') + '/';
          }
        }
        if (details.endPoint === 'approve') {
          this.url = 'http://localhost:8000/api/et2f/travels' + this.travelId + '/approve/';
        }
        if (details.endPoint === 'reject') {
          this.url = 'http://localhost:8000/api/et2f/travels' + this.travelId + '/reject/';
        }

        if (details.endPoint === 'cancel') {
          if(!this.newTravel) {
            this.url = 'http://localhost:8000/api/et2f/travels' + this.travelId + '/cancel/';
          } else {
            this._handlePostSuccess();
          }
        }
        if (details.endPoint === 'reopen') {
          this.url = 'http://localhost:8000/api/et2f/travels' + this.travelId + '/restore/';
        }
        if (details.endPoint === 'send_for_payment') {
          this.url = 'http://localhost:8000/api/et2f/travels' + this.travelId + '/send_for_payment/';
        }
        if (details.endPoint === 'submit') {
          this.url = 'http://localhost:8000/api/et2f/travels' + this.travelId + '/submit_for_approval/';
        }
        this.postData = true;
      },
      _handlePostFail: function(e, i) {
        console.log("post fail");
        console.log(e,i);
        this.postData = false;
      },
      _handlePostSuccess: function() {
        this.postData = false;
        this.fire('travel-post-success');
        this._resetData();
      },
      _resetData: function() {
        this.data = {
          baseDetails: {},
          activities: [{}],
          itinerary: [{}],
          expenses: [{}],
          costAssignment: [{}],
          status: 'Planned'
        }
      },
      ready: function () {
        if (this.newTravel) {
          this._resetData();
        }
      }
    });
  </script>
</dom-module>
