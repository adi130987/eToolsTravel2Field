<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/etools-ajax/etools-ajax.html">

<dom-module id="etools-data">

  <template>

    <iron-ajax id="ajax" method="get" handle-as="json" on-response="_handleResponse"></iron-ajax>

  </template>

  <script>

    var _data = {};
    var _els = [];

    var _setMetaData = function(key, data) {
      if (data) {
        _data[key] = data;
      }

      _.each(_els, function(el) {
        el.load(_data[key], key);
      });
    };

    Polymer({

      is: 'meta-data',

      properties: {

        data: {
          type: Object,
          notify: true,
          value: function() {
            return _data;
          }
        }

      }

    });

    Polymer({

      is: 'etools-data',

      ready: function() {
        this.load(_data);
      },

      attached: function() {
        //this.setListeners();
        this.listen(this._meta, 'countries-changed', '_metaDataChanged');
        if (_els.length === 0 && _.isEmpty(_data)) {
          //set url
          //generate request
        }
        _els.push(this);
      },

      detached: function() {
        _els.splice(_els.indexOf(this), 1);
      },

      properties: {

        _meta: {
          value: document.createElement('meta-data')
        },

        countries: {
          type: Array,
          readOnly: true,
          notify: true
        },

        _setters: {
          type: Object,
          value: {
            countries: function(data) { this._setCountries(data); }
          }
        }

      },

      hostAttributes: {
        hidden: true
      },

      observers: [
        '_dataChanged(countries.*)'
      ],

      load: function(data, key) {
        if (!_.isEmpty(data)) {
          if (key) {
            this._setters[key].bind(this)(data);
          } else {
            _.each(this._setters, function(setter, key) {
              setter.bind(this)(data[key]);
            }.bind(this));
          }
        }
      },

      add: function(newData) {
        this.push('countries', newData);
      },

      _dataChanged: function(info) {
        var eventName = info.path.split('.', 1)[0] + '-changed';
        this._meta.fire(eventName, info, {bubbles: false});
      },

      _metaDataChanged: function(e) {
        this.fire(e.type, e.detail);
      },

      _handleResponse: function(_, req) {
        //use response header to set data
        var url = req.xhr.responseURL;
        url = url.substring(url.indexOf('?id=') + 4);
        _setMetaData(url, req.response);
      },

    });

  </script>

</dom-module>
