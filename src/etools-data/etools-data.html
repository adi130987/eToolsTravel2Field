<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/etools-ajax/etools-ajax.html">

<dom-module id="etools-data">

  <template>

    <iron-ajax id="ajax" method="get" handle-as="json" on-response="_handleResponse"></iron-ajax>

  </template>

  <script>

    var _data = {};
    var _els = [];
    var _i = 0;

    var _setMetaData = function(key, data) {
      if (data) {
        _data[key] = data;
      }

      _.each(_els, function(el) {
        el.load(_data, key);
      });
    };

    Polymer({

      is: 'etools-data',

      ready: function() {
        this.load(_data);
      },

      attached: function() {
        if (_els.length === 0 && _.isEmpty(_data)) {
          //set url
          this.$.ajax.url = '../../data/countries.json';
          //generate request
          this.$.ajax.params = {'id': 'countries'};
          this.$.ajax.generateRequest();
        }
        _els.push(this);
      },

      detached: function() {
        _els.splice(_els.indexOf(this), 1);
      },

      properties: {

        partners: {
          type: Array,
          notify: true
        },

        countries: {
          type: Array,
          notify: true
        }

      },

      hostAttributes: {
        hidden: true
      },

      observers: [
        '_dataChanged(partners.*)',
        '_dataChanged(countries.*)',
      ],

      load: function(data, property) {
        if (!_.isEmpty(data)) {
          if (property) {
            this.set(property, data[property]);
          } else {
            Object.keys(this.properties).forEach(function(property) {
              this.set(property, data[property]);
            }.bind(this));
          }
        }
      },

      add: function(newData) {
        this.push('countries', newData);
        //this.set('countries.0.name', 'New Name');
      },

      _dataChanged: function(info) {
        var propertyName = info.path.split('.', 1)[0];
        var eventName = propertyName + '-changed';

        if (_i === 0 && !info.path.endsWith(propertyName)) {
          _.each(_els, function(el) {
            if (el !== this) {
              el.fire(eventName, info);
            }
            _i++;
          }.bind(this));
        }
        if (_i === _els.length) {
          _i = 0;
        }
      },

      _handleResponse: function(_, req) {
        var url = req.xhr.responseURL;
        url = url.substring(url.indexOf('?id=') + 4);
        _setMetaData(url, req.response);
      },

    });

  </script>

</dom-module>
